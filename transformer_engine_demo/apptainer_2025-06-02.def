# to use environment variables, create this file dynamically, e.g. cat > file.def << EOF.
# Add uv and git 

Bootstrap: localimage
From: /gpfs/home/gerlebacher/containers/cuda_nvidia_12.sif  # Base image pulled from nvidia/cuda:12.1.1-runtime-ubuntu22.04

%labels
    Maintainer Gordon
    Version 1.0
    Description CUDA 12.1.1 runtime + Python + uv, for NeMo training

# Executed during execution
%environment
    # Locale settings for UTF-8 compatibility in logs, file handling, etc.
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8

    # Ensure uv from pip is in PATH if installed to ~/.local/bin
    export PATH="/root/.local/bin:$PATH"
    
    # Set CUDA paths
    export CUDA_HOME=/usr/local/cuda
    export PATH="$CUDA_HOME/bin:$PATH"
    export LD_LIBRARY_PATH="$CUDA_HOME/lib64:$LD_LIBRARY_PATH"

# Executed during build
%post
    echo "Updating package list and installing pip, git, and CUDA dev tools..."
    apt-get update && apt-get install -y python3-pip git cuda-toolkit-12-1 && apt-get clean

    echo "Upgrading pip and installing uv..."
    python3 -m pip install --upgrade pip
    python3 -m pip install uv
    
    echo "Installing transformer-engine in container..."
    python3 -m pip install torch
    python3 -m pip install "transformer-engine[pytorch]"

    echo "Environment setup complete."
